---
title: "DRMR 2.0"
output: html_notebook
---

#Preperations

Delete everything
```{r}
rm(list = ls())
options(scipen = 0)
```

Load the packBirthYears
```{r}
library(haven)
library(dplyr)
library(tidyr)
library(foreign)
library(ivreg)
library(quantreg)
library(ggplot2)
library(quantregForest)
library(SUMnlmr)
```


#Data preparation
Load the dataset
```{r}
df_regression <- read_csv("2nd analysis/df_regression2.0.cvs")
```
Make the categorical numeric
```{r}
df_regression$Sex <- ifelse(df_regression$Sex == "Male", 1, 2)
df_regression$Smoking <- ifelse(df_regression$Smoking == "Never smoked", 1,
                                       ifelse(df_regression$Smoking == "Ex daily smoker", 2,
                                              ifelse(df_regression$Smoking == "Current daily smoker", 3,
                                                     ifelse(df_regression$Smoking == "Current occasional smoker", 4, 5))))
df_regression$Urbanity <- ifelse(df_regression$Urbanity == "Urban", 1, 2)
df_regression$Marital <- ifelse(df_regression$Marital == "Unmarried", 1,
                                       ifelse(df_regression$Marital == "Married", 2,
                                              ifelse(df_regression$Marital == "Widow, widower", 3,
                                                     ifelse(df_regression$Marital == "Divorced", 4, 5))))
df_regression$Bu_Edu <- ifelse(df_regression$Bu_Edu == "Primary School", 1,
                                       ifelse(df_regression$Bu_Edu == "Secondary school", 2,
                                              ifelse(df_regression$Bu_Edu == "Higher education short", 3, 4)))
df_regression$D_HUNT2 <- as.numeric(df_regression$D_HUNT2)
df_regression$D_HUNT3 <- as.numeric(df_regression$D_HUNT3)
```
Take away the NA
```{r}
df_regression_no_na <- na.omit(df_regression[, c("BMI", "yengogrs", "Smoking", "Urbanity", "BirthYear", "Marital", "Bu_Edu", "income_2020","D_HUNT2", "D_HUNT3", "lockegrs", "Sex")])
```
Make a group for Non Zero Income
Exclude those with an income=0
```{r}
df_regression_no_zincome <- df_regression_no_na[df_regression_no_na$income_2020 != 0, ]
```
Take away missing values from the variables
```{r}
df_regression_no_zincome <- na.omit(df_regression_no_zincome[, c("BMI", "yengogrs", "Smoking", "Urbanity", "BirthYear", "Marital", "Bu_Edu", "income_2020","D_HUNT2", "D_HUNT3", "lockegrs", "Sex")])
```
Create log variables for income in both
```{r}
df_regression_no_na$log_income <- log1p(df_regression_no_na$income_2020)
df_regression_no_zincome$log_income <- log(df_regression_no_zincome$income_2020)
df_regression_no_zincome <- df_regression_no_zincome[!is.nan(df_regression_no_zincome$log_income), ]
```
Generate one for males and females
```{r}
df_regression_male <- subset(df_regression_no_na, Sex == 1)
df_regression_female <- subset(df_regression_no_na, Sex == 2)
df_regression_male_NZI <- subset(df_regression_no_zincome, Sex == 1)
df_regression_female_NZI <- subset(df_regression_no_zincome, Sex == 2)
```

#Male and female togehter Yengo
```{r}
summ_covar<-create_nlmr_summary(y = df_regression_no_na$log_income,
                                x = df_regression_no_na$BMI,
                                g = df_regression_no_na$yengogrs,
                                covar = matrix(data=c(df_regression_no_na$Smoking,
                                                      df_regression_no_na$Urbanity,
                                                      df_regression_no_na$Bu_Edu,
                                                      df_regression_no_na$BirthYear,
                                                      df_regression_no_na$Marital,
                                                      df_regression_no_na$Sex,
                                                      df_regression_no_na$D_HUNT2,
                                                      df_regression_no_na$D_HUNT3
                                                      ),ncol=8),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_regression_no_zincome$log_income,
                                x = df_regression_no_zincome$BMI,
                                g = df_regression_no_zincome$yengogrs,
                                covar = matrix(data=c(df_regression_no_zincome$Smoking,
                                                      df_regression_no_zincome$Urbanity,
                                                      df_regression_no_zincome$Bu_Edu,
                                                      df_regression_no_zincome$BirthYear,
                                                      df_regression_no_zincome$Marital,
                                                      df_regression_no_zincome$Sex,
                                                      df_regression_no_zincome$D_HUNT2,
                                                      df_regression_no_zincome$D_HUNT3
                                                      ),ncol=8),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo NZI")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo NZI.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo NZI")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo NZI.png", plot = plot2)

```

#Male and female togehter Locke
```{r}
summ_covar<-create_nlmr_summary(y = df_regression_no_na$log_income,
                                x = df_regression_no_na$BMI,
                                g = df_regression_no_na$lockegrs,
                                covar = matrix(data=c(df_regression_no_na$Smoking,
                                                      df_regression_no_na$Urbanity,
                                                      df_regression_no_na$Bu_Edu,
                                                      df_regression_no_na$BirthYear,
                                                      df_regression_no_na$Marital,
                                                      df_regression_no_na$Sex,
                                                      df_regression_no_na$D_HUNT2,
                                                      df_regression_no_na$D_HUNT3
                                                      ),ncol=8),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_regression_no_zincome$log_income,
                                x = df_regression_no_zincome$BMI,
                                g = df_regression_no_zincome$lockegrs,
                                covar = matrix(data=c(df_regression_no_zincome$Smoking,
                                                      df_regression_no_zincome$Urbanity,
                                                      df_regression_no_zincome$Bu_Edu,
                                                      df_regression_no_zincome$BirthYear,
                                                      df_regression_no_zincome$Marital,
                                                      df_regression_no_zincome$Sex,
                                                      df_regression_no_zincome$D_HUNT2,
                                                      df_regression_no_zincome$D_HUNT3
                                                      ),ncol=8),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke NZI")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke NZI.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke NZI")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke NZI.png", plot = plot2)

```

#Male Yengo
```{r}
summ_covar<-create_nlmr_summary(y = df_regression_male$log_income,
                                x = df_regression_male$BMI,
                                g = df_regression_male$yengogrs,
                                covar = matrix(data=c(df_regression_male$Smoking,
                                                      df_regression_male$Urbanity,
                                                      df_regression_male$Bu_Edu,
                                                      df_regression_male$BirthYear,
                                                      df_regression_male$Marital,
                                                      df_regression_male$D_HUNT2,
                                                      df_regression_male$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo male")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo male.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo male")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo male.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_regression_male_NZI$log_income,
                                x = df_regression_male_NZI$BMI,
                                g = df_regression_male_NZI$yengogrs,
                                covar = matrix(data=c(df_regression_male_NZI$Smoking,
                                                      df_regression_male_NZI$Urbanity,
                                                      df_regression_male_NZI$Bu_Edu,
                                                      df_regression_male_NZI$BirthYear,
                                                      df_regression_male_NZI$Marital,
                                                      df_regression_male_NZI$D_HUNT2,
                                                      df_regression_male_NZI$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo male NZI")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo male NZI.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo male NZI")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo male NZI.png", plot = plot2)

```

#Male Locke
```{r}
summ_covar<-create_nlmr_summary(y = df_regression_male$log_income,
                                x = df_regression_male$BMI,
                                g = df_regression_male$lockegrs,
                                covar = matrix(data=c(df_regression_male$Smoking,
                                                      df_regression_male$Urbanity,
                                                      df_regression_male$Bu_Edu,
                                                      df_regression_male$BirthYear,
                                                      df_regression_male$Marital,
                                                      df_regression_male$D_HUNT2,
                                                      df_regression_male$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke male")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke male.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke male")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke male.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_regression_male_NZI$log_income,
                                x = df_regression_male_NZI$BMI,
                                g = df_regression_male_NZI$lockegrs,
                                covar = matrix(data=c(df_regression_male_NZI$Smoking,
                                                      df_regression_male_NZI$Urbanity,
                                                      df_regression_male_NZI$Bu_Edu,
                                                      df_regression_male_NZI$BirthYear,
                                                      df_regression_male_NZI$Marital,
                                                      df_regression_male_NZI$D_HUNT2,
                                                      df_regression_male_NZI$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke male NZI")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke male NZI.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke male NZI")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke male NZI.png", plot = plot2)

```

#Female Yengo
```{r}
summ_covar<-create_nlmr_summary(y = df_regression_female$log_income,
                                x = df_regression_female$BMI,
                                g = df_regression_female$yengogrs,
                                covar = matrix(data=c(df_regression_female$Smoking,
                                                      df_regression_female$Urbanity,
                                                      df_regression_female$Bu_Edu,
                                                      df_regression_female$BirthYear,
                                                      df_regression_female$Marital,
                                                      df_regression_female$D_HUNT2,
                                                      df_regression_female$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo female")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo female.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo female")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo female.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_regression_female_NZI$log_income,
                                x = df_regression_female_NZI$BMI,
                                g = df_regression_female_NZI$yengogrs,
                                covar = matrix(data=c(df_regression_female_NZI$Smoking,
                                                      df_regression_female_NZI$Urbanity,
                                                      df_regression_female_NZI$Bu_Edu,
                                                      df_regression_female_NZI$BirthYear,
                                                      df_regression_female_NZI$Marital,
                                                      df_regression_female_NZI$D_HUNT2,
                                                      df_regression_female_NZI$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo female NZI")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo female NZI.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo female NZI")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo female NZI.png", plot = plot2)

```

#Female Locke
```{r}
summ_covar<-create_nlmr_summary(y = df_regression_female$log_income,
                                x = df_regression_female$BMI,
                                g = df_regression_female$lockegrs,
                                covar = matrix(data=c(df_regression_female$Smoking,
                                                      df_regression_female$Urbanity,
                                                      df_regression_female$Bu_Edu,
                                                      df_regression_female$BirthYear,
                                                      df_regression_female$Marital,
                                                      df_regression_female$D_HUNT2,
                                                      df_regression_female$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke female")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke female.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke female")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke female.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_regression_female_NZI$log_income,
                                x = df_regression_female_NZI$BMI,
                                g = df_regression_female_NZI$lockegrs,
                                covar = matrix(data=c(df_regression_female_NZI$Smoking,
                                                      df_regression_female_NZI$Urbanity,
                                                      df_regression_female_NZI$Bu_Edu,
                                                      df_regression_female_NZI$BirthYear,
                                                      df_regression_female_NZI$Marital,
                                                      df_regression_female_NZI$D_HUNT2,
                                                      df_regression_female_NZI$D_HUNT3
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke female NZI")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke female NZI.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke female NZI")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke female NZI.png", plot = plot2)

```


#Data Christina
Load the dataset
```{r}
df_Christina <- read_dta("2nd analysis/df_Christina.dta")
```

```{r}
df_Christina$Sex <- as.numeric(df_Christina$Sex)
df_Christina$Bu_Edu <- as.numeric(df_Christina$Bu_Edu)
```

Take away the NA
```{r}
df_Christina_no_na <- na.omit(df_Christina[, c("BMI", "yengogrs", "Smoking", "Urbanity", "BirthYear", "Marital", "Bu_Edu", "Income_Eur","D_HUNT2", "D_HUNT3", "lockegrs", "Sex", "prob_income_positive")])

df_Christina_no_na <- df_Christina_no_na[df_Christina_no_na$Income_Eur >= 0, ]
```
Make a group for Non Zero Income
Exclude those with an income=0
```{r}
df_Christina_no_zincome <- df_Christina_no_na[df_Christina_no_na$Income_Eur != 0, ]
```
Take away missing values from the variables
```{r}
df_Christina_no_zincome <- na.omit(df_Christina_no_zincome[, c("BMI", "yengogrs", "Smoking", "Urbanity", "BirthYear", "Marital", "Bu_Edu", "Income_Eur","D_HUNT2", "D_HUNT3", "lockegrs", "Sex", "prob_income_positive")])
```
Create log variables for income in both
```{r}
df_Christina_no_na$log_income <- log1p(df_Christina_no_na$Income_Eur)
df_Christina_no_zincome$log_income <- log(df_Christina_no_zincome$Income_Eur)
df_Christina_no_zincome <- df_Christina_no_zincome[!is.nan(df_Christina_no_zincome$Income_Eur), ]
```
Generate one for males and females
```{r}
df_Christina_male <- subset(df_Christina_no_na, Sex == 2)
df_Christina_female <- subset(df_Christina_no_na, Sex == 1)
df_Christina_male_NZI <- subset(df_Christina_no_zincome, Sex == 2)
df_Christina_female_NZI <- subset(df_Christina_no_zincome, Sex == 1)
```

#Analysis with Christina Data

#Male and female togehter Yengo
```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_no_na$log_income,
                                x = df_Christina_no_na$BMI,
                                g = df_Christina_no_na$yengogrs,
                                covar = matrix(data=c(df_Christina_no_na$Smoking,
                                                      df_Christina_no_na$Urbanity,
                                                      df_Christina_no_na$Bu_Edu,
                                                      df_Christina_no_na$BirthYear,
                                                      df_Christina_no_na$Marital,
                                                      df_Christina_no_na$Sex,
                                                      df_Christina_no_na$D_HUNT2
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income YengoChris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo Chris.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_no_zincome$log_income,
                                x = df_Christina_no_zincome$BMI,
                                g = df_Christina_no_zincome$yengogrs,
                                covar = matrix(data=c(df_Christina_no_zincome$Smoking,
                                                      df_Christina_no_zincome$Urbanity,
                                                      df_Christina_no_zincome$Bu_Edu,
                                                      df_Christina_no_zincome$BirthYear,
                                                      df_Christina_no_zincome$Marital,
                                                      df_Christina_no_zincome$Sex,
                                                      df_Christina_no_zincome$D_HUNT2
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo NZI Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo NZI Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo NZI Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo NZI Chris.png", plot = plot2)

```

#Male and female togehter Locke
```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_no_na$log_income,
                                x = df_Christina_no_na$BMI,
                                g = df_Christina_no_na$lockegrs,
                                covar = matrix(data=c(df_Christina_no_na$Smoking,
                                                      df_Christina_no_na$Urbanity,
                                                      df_Christina_no_na$Bu_Edu,
                                                      df_Christina_no_na$BirthYear,
                                                      df_Christina_no_na$Marital,
                                                      df_Christina_no_na$Sex,
                                                      df_Christina_no_na$D_HUNT2
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke Chris.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_no_zincome$log_income,
                                x = df_Christina_no_zincome$BMI,
                                g = df_Christina_no_zincome$lockegrs,
                                covar = matrix(data=c(df_Christina_no_zincome$Smoking,
                                                      df_Christina_no_zincome$Urbanity,
                                                      df_Christina_no_zincome$Bu_Edu,
                                                      df_Christina_no_zincome$BirthYear,
                                                      df_Christina_no_zincome$Marital,
                                                      df_Christina_no_zincome$Sex,
                                                      df_Christina_no_zincome$D_HUNT2
                                                      ),ncol=7),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke NZI Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke NZI Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke NZI Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke NZI Chris.png", plot = plot2)

```

#Male Yengo
```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_male$log_income,
                                x = df_Christina_male$BMI,
                                g = df_Christina_male$yengogrs,
                                covar = matrix(data=c(df_Christina_male$Smoking,
                                                      df_Christina_male$Urbanity,
                                                      df_Christina_male$Bu_Edu,
                                                      df_Christina_male$BirthYear,
                                                      df_Christina_male$Marital,
                                                      df_Christina_male$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo male Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo male Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo male Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo male Chris.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_male_NZI$log_income,
                                x = df_Christina_male_NZI$BMI,
                                g = df_Christina_male_NZI$yengogrs,
                                covar = matrix(data=c(df_Christina_male_NZI$Smoking,
                                                      df_Christina_male_NZI$Urbanity,
                                                      df_Christina_male_NZI$Bu_Edu,
                                                      df_Christina_male_NZI$BirthYear,
                                                      df_Christina_male_NZI$Marital,
                                                      df_Christina_male_NZI$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo male NZI Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo male NZI Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo male NZI Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo male NZI Chris.png", plot = plot2)

```

#Male Locke
```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_male$log_income,
                                x = df_Christina_male$BMI,
                                g = df_Christina_male$lockegrs,
                                covar = matrix(data=c(df_Christina_male$Smoking,
                                                      df_Christina_male$Urbanity,
                                                      df_Christina_male$Bu_Edu,
                                                      df_Christina_male$BirthYear,
                                                      df_Christina_male$Marital,
                                                      df_Christina_male$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke male Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke male Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke male Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke male Chris.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_male_NZI$log_income,
                                x = df_Christina_male_NZI$BMI,
                                g = df_Christina_male_NZI$lockegrs,
                                covar = matrix(data=c(df_Christina_male_NZI$Smoking,
                                                      df_Christina_male_NZI$Urbanity,
                                                      df_Christina_male_NZI$Bu_Edu,
                                                      df_Christina_male_NZI$BirthYear,
                                                      df_Christina_male_NZI$Marital,
                                                      df_Christina_male_NZI$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke male NZI Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke male NZI Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke male NZI Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke male NZI Chris.png", plot = plot2)

```

#Female Yengo
```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_female$log_income,
                                x = df_Christina_female$BMI,
                                g = df_Christina_female$yengogrs,
                                covar = matrix(data=c(df_Christina_female$Smoking,
                                                      df_Christina_female$Urbanity,
                                                      df_Christina_female$Bu_Edu,
                                                      df_Christina_female$BirthYear,
                                                      df_Christina_female$Marital,
                                                      df_Christina_female$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo female Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo female Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo female Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo female Chris.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_female_NZI$log_income,
                                x = df_Christina_female_NZI$BMI,
                                g = df_Christina_female_NZI$yengogrs,
                                covar = matrix(data=c(df_Christina_female_NZI$Smoking,
                                                      df_Christina_female_NZI$Urbanity,
                                                      df_Christina_female_NZI$Bu_Edu,
                                                      df_Christina_female_NZI$BirthYear,
                                                      df_Christina_female_NZI$Marital,
                                                      df_Christina_female_NZI$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Yengo female NZI Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Yengo female NZI Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Yengo female NZI Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Yengo female NZI Chris.png", plot = plot2)

```

#Female Locke
```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_female$log_income,
                                x = df_Christina_female$BMI,
                                g = df_Christina_female$lockegrs,
                                covar = matrix(data=c(df_Christina_female$Smoking,
                                                      df_Christina_female$Urbanity,
                                                      df_Christina_female$Bu_Edu,
                                                      df_Christina_female$BirthYear,
                                                      df_Christina_female$Marital,
                                                      df_Christina_female$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke female Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke female Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke female Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke female Chris.png", plot = plot2)

```

```{r}
summ_covar<-create_nlmr_summary(y = df_Christina_female_NZI$log_income,
                                x = df_Christina_female_NZI$BMI,
                                g = df_Christina_female_NZI$lockegrs,
                                covar = matrix(data=c(df_Christina_female_NZI$Smoking,
                                                      df_Christina_female_NZI$Urbanity,
                                                      df_Christina_female_NZI$Bu_Edu,
                                                      df_Christina_female_NZI$BirthYear,
                                                      df_Christina_female_NZI$Marital,
                                                      df_Christina_female_NZI$D_HUNT2
                                                      ),ncol=6),
                                family = "gaussian",
                                strata_method = "ranked", 
                                q = 10)
# fractional polynomial fit from semi-summarized data
model<- with(summ_covar$summary, frac_poly_summ_mr(bx=bx,
                  by=by, 
                  bxse=bxse, 
                  byse=byse, 
                  xmean=xmean,
                  family="gaussian",
                  fig=TRUE)
)
plot1 <- model$figure +
  ggtitle("fract polynom fit from semi-summ data log income Locke female NZI Chris")

plot1
ggsave("Graphs/fractional polynomial fit from semi-summarized data log income Locke female NZI Chris.png", plot = plot1)

model$p_tests

model$p_heterogeneity

# piecewise linear fit from semi-summarized data
model2 <-with(summ_covar$summary, piecewise_summ_mr(by, bx, byse, bxse, xmean, xmin,xmax, 
                  ci="bootstrap_se",
                  nboot=1000, 
                  fig=TRUE,
                  family="gaussian",
                  ci_fig="ribbon")
)

plot2 <- model2$figure +
  ggtitle("piecewise_lin fit from semi-summ data log income Locke female NZI Chris")

plot2
ggsave("Graphs/piecewise linear fit from semi-summarized data log income Locke female NZI Chris.png", plot = plot2)

```

